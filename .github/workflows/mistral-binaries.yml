name: 'Manual Build Mistral.rs Binaries'

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve latest mistral.rs release tag
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: 'EricLBuehler',
              repo: 'mistral.rs',
            });

            let tag = (release.data.tag_name || '').trim();
            if (!tag) {
              core.setFailed('Latest mistral.rs release tag is empty');
              return;
            }

            if (!tag.startsWith('v')) {
              tag = `v${tag}`;
            }

            core.info(`Using mistral.rs release tag: ${tag}`);
            core.setOutput('tag', tag);

  build:
    needs: resolve-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-14'
            rust_targets: ''
            cargo_target: ''
            features: 'accelerate,metal'
            asset_suffix: 'macos-arm64'
            archive_ext: 'tar.gz'
            clear_build_rustflags: 'false'
            clear_target_rustflags_key: ''

          - platform: 'macos-14'
            rust_targets: 'x86_64-apple-darwin'
            cargo_target: 'x86_64-apple-darwin'
            features: 'accelerate,metal'
            asset_suffix: 'macos-x64'
            archive_ext: 'tar.gz'
            clear_build_rustflags: 'true'
            clear_target_rustflags_key: 'target.x86_64-apple-darwin.rustflags'

          - platform: 'ubuntu-22.04'
            rust_targets: ''
            cargo_target: ''
            features: ''
            asset_suffix: 'ubuntu-cpu-x64'
            archive_ext: 'tar.gz'
            clear_build_rustflags: 'false'
            clear_target_rustflags_key: ''

          - platform: 'windows-latest'
            rust_targets: ''
            cargo_target: ''
            features: ''
            asset_suffix: 'win-cpu-x64'
            archive_ext: 'zip'
            clear_build_rustflags: 'false'
            clear_target_rustflags_key: ''

          - platform: 'windows-latest'
            rust_targets: 'aarch64-pc-windows-msvc'
            cargo_target: 'aarch64-pc-windows-msvc'
            features: ''
            asset_suffix: 'win-cpu-arm64'
            archive_ext: 'zip'
            clear_build_rustflags: 'true'
            clear_target_rustflags_key: ''

    runs-on: ${{ matrix.platform }}
    env:
      MISTRAL_TAG: ${{ needs.resolve-version.outputs.tag }}
      ASSET_NAME: mistral-${{ needs.resolve-version.outputs.tag }}-bin-${{ matrix.asset_suffix }}
      MISTRAL_SRC_DIR: ./.mistral-rs-src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './.mistral-rs-src -> target'

      - name: Clone mistral.rs
        shell: bash
        run: |
          rm -rf "${MISTRAL_SRC_DIR}"
          git clone --depth 1 --branch "${MISTRAL_TAG}" \
            https://github.com/EricLBuehler/mistral.rs.git "${MISTRAL_SRC_DIR}"

      - name: Build mistralrs binary
        shell: bash
        run: |
          set -euo pipefail

          config_args=()
          if [[ "${{ matrix.clear_build_rustflags }}" == "true" ]]; then
            config_args+=(--config "build.rustflags=[]")
          fi
          if [[ -n "${{ matrix.clear_target_rustflags_key }}" ]]; then
            config_args+=(--config "${{ matrix.clear_target_rustflags_key }}=[]")
          fi

          cargo_args=()
          if [[ -n "${{ matrix.cargo_target }}" ]]; then
            cargo_args+=(--target "${{ matrix.cargo_target }}")
          fi
          if [[ -n "${{ matrix.features }}" ]]; then
            cargo_args+=(--features "${{ matrix.features }}")
          fi

          echo "Building ${ASSET_NAME} from mistral.rs ${MISTRAL_TAG}"
          cd "${MISTRAL_SRC_DIR}"
          packages=(mistralrs-server)
          for pkg in "${packages[@]}"; do
            cargo ${config_args[@]+"${config_args[@]}"} build -p "$pkg" --release ${cargo_args[@]+"${cargo_args[@]}"}
          done

      - name: Package archive (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          target_dir="${MISTRAL_SRC_DIR}/target/release"
          if [[ -n "${{ matrix.cargo_target }}" ]]; then
            target_dir="${MISTRAL_SRC_DIR}/target/${{ matrix.cargo_target }}/release"
          fi

          mkdir -p "dist/stage/${ASSET_NAME}"
          binaries=(mistralrs-server)
          for bin in "${binaries[@]}"; do
            bin_path="${target_dir}/${bin}"
            if [[ ! -f "$bin_path" ]]; then
              echo "Binary not found: $bin_path"
              exit 1
            fi
            cp "$bin_path" "dist/stage/${ASSET_NAME}/${bin}"
            chmod +x "dist/stage/${ASSET_NAME}/${bin}"
          done
          tar -czf "dist/${ASSET_NAME}.tar.gz" -C dist/stage "${ASSET_NAME}"

      - name: Package archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $targetDir = "$env:MISTRAL_SRC_DIR/target/release"
          if ("${{ matrix.cargo_target }}" -ne "") {
            $targetDir = "$env:MISTRAL_SRC_DIR/target/${{ matrix.cargo_target }}/release"
          }

          $stageDir = Join-Path "dist/stage" $env:ASSET_NAME
          New-Item -ItemType Directory -Path $stageDir -Force | Out-Null
          $binaries = @("mistralrs-server.exe")
          foreach ($bin in $binaries) {
            $binPath = Join-Path $targetDir $bin
            if (-not (Test-Path $binPath)) {
              throw "Binary not found: $binPath"
            }
            Copy-Item $binPath (Join-Path $stageDir $bin) -Force
          }

          $archivePath = "dist/$($env:ASSET_NAME).zip"
          if (Test-Path $archivePath) {
            Remove-Item $archivePath -Force
          }
          Compress-Archive -Path "$stageDir/*" -DestinationPath $archivePath -Force

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ASSET_NAME }}.${{ matrix.archive_ext }}
          path: dist/${{ env.ASSET_NAME }}.${{ matrix.archive_ext }}
          if-no-files-found: error

  publish-draft:
    needs: [resolve-version, build]
    runs-on: ubuntu-latest
    env:
      MISTRAL_TAG: ${{ needs.resolve-version.outputs.tag }}
      RELEASE_TAG: mistral-${{ needs.resolve-version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Prepare release notes
        shell: bash
        run: |
          set -euo pipefail
          ls -la dist

          cat > release_notes.md <<EOF
          ## Binaries

          Prebuilt `mistralrs-server` binaries packaged for Oxide backend integration.

          ### Platforms
          - macOS Apple Silicon (`accelerate + metal`)
          - macOS Intel (`accelerate + metal`)
          - Ubuntu x86_64 (`cpu`)
          - Windows x86_64 (`cpu`)
          - Windows ARM64 (`cpu`)

          ### Version Source
          The packaged binaries are built from upstream `EricLBuehler/mistral.rs` release:
          - Tag: `${MISTRAL_TAG}`
          - URL: `https://github.com/EricLBuehler/mistral.rs/releases/tag/${MISTRAL_TAG}`

          ### Included Artifacts
          EOF

          {
            for f in dist/*; do
              [ -f "$f" ] || continue
              printf -- "- `%s`\n" "$(basename "$f")"
            done
          } >> release_notes.md

      - name: Create or update draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          title="mistral.rs ${MISTRAL_TAG} binaries"

          if gh release view "${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Release ${RELEASE_TAG} already exists, updating draft and assets..."
            gh release edit "${RELEASE_TAG}" \
              --title "${title}" \
              --notes-file release_notes.md \
              --draft
            gh release upload "${RELEASE_TAG}" dist/* --clobber
          else
            echo "Creating draft release ${RELEASE_TAG}..."
            gh release create "${RELEASE_TAG}" dist/* \
              --title "${title}" \
              --notes-file release_notes.md \
              --draft
          fi
